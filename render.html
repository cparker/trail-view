<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Trail View Render</title>
  <link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="render.css">
</head>

<body class="render">
  <script src="node_modules/leaflet/dist/leaflet.js"></script>
  <script src='node_modules/leaflet-omnivore/leaflet-omnivore.min.js'></script>
  <script src='node_modules/leaflet-rotatedmarker/leaflet.rotatedMarker.js'></script>

  <div class="main-video">
    <video src="" poster="video-placeholder.jpg"></video>
    <div class="text-overlay">
      <label id="title">Rabbit Valley</label>
      <label id="date-time">Saturday May 5th, 2017</label>
      <label id="speed-elevation"><span id="speed-field">--</span> MPH, <span id="elevation-field">5280</span> Ft., <span id="heading-field">342</span>º <span id="compass-field">NNW</span></label>
      <!-- TODO can't forget to make N and W dynamic!!! -->
      <label id="latlon"><span id="lat-field">45.042975421</span> º N, <span id="lon-field">-104.12348731</span> º W</label>
    </div>
    <div id="map" class="map-overlay"></div>
    <div class="elevation-graph-outer">
      <div class="elevation-graph-inner">
        <canvas id="elevation-canvas-element"></canvas>
        <canvas id="current-elevation-marker-canvas-element"></canvas>
      </div>
    </div>
  </div>


  <script>
    window.addEventListener('load', function() {
      const mimeType = 'video/webm;codecs=vp9'
      let recorder, chunks

      console.log('new window is loaded')
      const electron = require('electron')
      const remote = electron.remote
      const sharedObj = remote.getGlobal('sharedObj')
      const fs = require('fs')
      console.log('sharedObj', sharedObj)
      const renderVidElm = document.querySelector('.render video')
      renderVidElm.src = sharedObj.videoURL
      renderVidElm.currentTime = sharedObj.videoTime
      renderVidElm.playbackRate = 0.25
      renderVidElm.play()
      const {
        desktopCapturer
      } = electron

      function handleStopRecord() {
        const fileName = 'foo.webm'
        console.log('stop record')
        recorder.onstop = (event) => {
          console.log('recorder stopped')
          let bigBlob = new Blob(chunks, {
            type: mimeType
          })
          console.log('bigBlob', bigBlob)
          let reader = new FileReader()
          reader.onloadend = () => {
            console.log('we have a result', reader.result)

            // now convert from the array buffer to a node.js Buffer
            let nodeBuffer = Buffer.from(reader.result)
            console.log('node buffer', nodeBuffer)

            fs.writeFile(fileName, nodeBuffer, err => {
              if (err) {
                console.log('error writing file', err)
              } else {
                console.log(`saved ${fileName}`)
              }

            })
          }
          reader.readAsArrayBuffer(bigBlob)

        }
        recorder.stop()

      }

      renderVidElm.addEventListener('ended', handleStopRecord)


      function handleMediaStream(stream) {
        console.log('handling media stream', stream)
        recorder = new MediaRecorder(stream, {
          mimeType: mimeType
        })
        chunks = []
        recorder.ondataavailable = (event) => {
          console.log('got some video data', event)
          chunks.push(event.data)
        }

        recorder.onerror = (err) => {
          console.log('recorder error', error)
        }

        recorder.start()

        console.log('recorder is now', recorder)

        // setInterval(() => {
        //   console.log(`chunk length now ${chunks.length}`)
        //   console.log('recorder', recorder)
        // }, 1000)
      }


      function handleMediaError(error) {
        console.log('got media error', error)
      }

      desktopCapturer.getSources({
        types: ['window']
      }, (error, sources) => {
        if (error) {
          console.log('error getting sources', error)
        }

        sources.forEach(source => {
          console.log('source', source)
        })

        let ourScreen = sources.find(s => s.name.toLowerCase().indexOf('trail view render') != -1)

        navigator.webkitGetUserMedia({
          audio: false,
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: ourScreen.id,
              minWidth: renderVidElm.videoWidth,
              minHeight: renderVidElm.videoHeight,
              maxWidth: renderVidElm.videoWidth,
              maxHeight: renderVidElm.videoHeight
            }
          }
        }, handleMediaStream, handleMediaError)

      })
    })
  </script>
</body>

</html>
